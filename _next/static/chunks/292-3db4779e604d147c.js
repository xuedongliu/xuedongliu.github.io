"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[292],{292:function(e,n,t){t.r(n),t.d(n,{default:function(){return z}});var r=t(947),i=t(1296),a=t(8417),l=t(4154),s=t(1999),o=t(2601),u=t(5789),c=t(99),d=t(3672),f=t.n(d),v=t(9218),h=t(6248),b=t(4816),m=function(e){void 0===e&&(e=new Set);var n=(0,h.useState)(e),t=n[0],r=n[1],i=(0,h.useMemo)((function(){return{add:function(e){return r((function(n){return new Set((0,l.__spreadArrays)(Array.from(n),[e]))}))},remove:function(e){return r((function(n){return new Set(Array.from(n).filter((function(n){return n!==e})))}))},toggle:function(e){return r((function(n){return n.has(e)?new Set(Array.from(n).filter((function(n){return n!==e}))):new Set((0,l.__spreadArrays)(Array.from(n),[e]))}))},reset:function(){return r(e)},clear:function(){return r(new Set)}}}),[r]),a=(0,l.__assign)({has:(0,h.useCallback)((function(e){return t.has(e)}),[t])},i);return[t,a]};function p(e){var n=(0,h.useRef)();return(0,h.useEffect)((function(){n.current=e})),n.current}var x=t(3410),g=t(9226),y=t(243),w=t(2829),j=t(7593),_=t(6654),k=t(2080),N=t(1234),C="src";function z(){var e,n=(0,j.Ys)().focusedTab,t=(0,v.useRouter)(),r=new URL(window.location.href).searchParams.get(C),i=(0,h.useState)(!!r),a=i[0],l=i[1];return(0,w.gp)(),(0,h.useEffect)((function(){var e=t.query.src;e&&(Array.isArray(e)||(e=[e]),Promise.all(e.map((function(e){return(0,y.F3)(e).then((function(e){j.r1.addTab(e)}))}))).finally((function(){return l(!1)})))}),[t.query]),(0,h.useEffect)((function(){"launchQueue"in window&&"LaunchParams"in window&&window.launchQueue.setConsumer((function(e){console.log("launchQueue",e),e.files.length&&Promise.all(e.files.map((function(e){return e.getFile()}))).then((function(e){return(0,y.Np)(e)})).then((function(e){return e.forEach((function(e){return j.r1.addTab(e)}))}))}))}),[]),(0,h.useEffect)((function(){t.beforePopState((function(e){return"/"===e.url&&j.r1.clear(),!0}))}),[t]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(f(),{children:[(0,s.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"}),(0,s.jsx)("title",{children:null!==(e=null===n||void 0===n?void 0:n.title)&&void 0!==e?e:"Flow"})]}),(0,s.jsx)(x.Yz,{}),a||(0,s.jsx)(A,{})]})}var A=function(){var e,n=(0,w.yX)(),t=(0,c.useLiveQuery)((function(){return null!==(e=null===g.db||void 0===g.db?void 0:g.db.covers.toArray())&&void 0!==e?e:[]})),u=(0,w.$G)("home"),d=(0,w.IF)(),f=d.data,v=d.mutate,z=(0,w.MX)(),A=z.data,S=z.mutate,E=p(f),Z=p(A),T=(0,i.Z)((0,o.kt)(!1),2),D=T[0],P=T[1],R=(0,i.Z)(m(),2),B=R[0],G=R[1],L=G.add,Q=G.has,X=G.toggle,q=G.reset,I=(0,h.useState)(),M=I[0],Y=I[1],U=(0,h.useState)(!1),V=U[0],J=U[1],$=(0,j.Ys)().groups;if((0,h.useEffect)((function(){Z&&A&&(null===g.db||void 0===g.db||g.db.books.toArray().then((function(e){if(0!==e.length){var n=A.map((function(n){return e.find((function(e){return e.name===n.name}))}));(0,k.xF)(n),v(n,{revalidate:!1})}})))}),[v,A]),(0,h.useEffect)((function(){!E&&f&&(null===g.db||void 0===g.db||g.db.books.bulkPut(f).then((function(){return J(!0)})))}),[f]),(0,h.useEffect)((function(){A&&V&&(null===g.db||void 0===g.db||g.db.books.toArray().then(function(){var e=(0,r.Z)((function(e){var n,t,r,i,a,s,o;return(0,l.__generator)(this,(function(u){switch(u.label){case 0:n=!0,t=!1,r=void 0,u.label=1;case 1:u.trys.push([1,6,7,8]),i=function(){var n,t;return(0,l.__generator)(this,(function(r){switch(r.label){case 0:return n=s.value,(t=e.find((function(e){return e.name===n.name})))?[4,null===g.db||void 0===g.db?void 0:g.db.files.get(t.id)]:[2,"continue"];case 1:return r.sent()?[2,"continue"]:(Y(t.id),[4,k.if.filesDownload({path:"/files/".concat(n.name)}).then((function(e){var n=e.result.fileBlob;return(0,y.N2)(t.id,new File([n],t.name))}))]);case 2:return r.sent(),Y(void 0),[2]}}))},a=A[Symbol.iterator](),u.label=2;case 2:return(n=(s=a.next()).done)?[3,5]:[5,(0,l.__values)(i())];case 3:u.sent(),u.label=4;case 4:return n=!0,[3,2];case 5:return[3,8];case 6:return o=u.sent(),t=!0,r=o,[3,8];case 7:try{n||null==a.return||a.return()}finally{if(t)throw r}return[7];case 8:return[2]}}))}));return function(n){return e.apply(this,arguments)}}()))}),[V,A]),(0,h.useEffect)((function(){D||q()}),[q,D]),$.length)return null;if(!n)return null;var H=(0,a.Z)(B).map((function(e){return n.find((function(n){return n.id===e}))})),K=B.size===n.length;return(0,s.jsxs)(x.rE,{className:"scroll-parent h-full p-4",onDrop:function(e){var t=e.dataTransfer.getData("text/plain"),r=n.find((function(e){return e.id===t}));r&&j.r1.addTab(r),(0,y.Np)(e.dataTransfer.files)},children:[(0,s.jsxs)("div",{className:"mb-4 space-y-2.5",children:[(0,s.jsx)("div",{children:(0,s.jsx)(x.nv,{name:C,placeholder:"https://link.to/remote.epub",type:"url",hideLabel:!0,actions:[{title:u("share"),Icon:b.Npg,onClick:function(e){(null===e||void 0===e?void 0:e.reportValidity())&&(0,N.JG)("".concat(window.location.origin,"/?").concat(C,"=").concat(e.value))}},{title:u("download"),Icon:b.qm7,onClick:function(e){(null===e||void 0===e?void 0:e.reportValidity())&&(0,y.F3)(e.value)}}]})}),(0,s.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,s.jsxs)("div",{className:"space-x-2",children:[n.length?(0,s.jsx)(x.zx,{variant:"secondary",onClick:P,children:u(D?"cancel":"select")}):(0,s.jsx)(x.zx,{variant:"secondary",disabled:!n,onClick:function(){(0,y.F3)("https://epubtest.org/books/Fundamental-Accessibility-Tests-Basic-Functionality-v1.0.0.epub")},children:u("download_sample_book")}),D&&(K?(0,s.jsx)(x.zx,{variant:"secondary",onClick:q,children:u("deselect_all")}):(0,s.jsx)(x.zx,{variant:"secondary",onClick:function(){return n.forEach((function(e){return L(e.id)}))},children:u("select_all")}))]}),(0,s.jsx)("div",{className:"space-x-2",children:D?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(x.zx,{onClick:(0,r.Z)((function(){var e,n,t,r,i,a,s;return(0,l.__generator)(this,(function(o){switch(o.label){case 0:P(),e=!0,n=!1,t=void 0,o.label=1;case 1:o.trys.push([1,6,7,8]),r=function(){var e,n;return(0,l.__generator)(this,(function(t){switch(t.label){case 0:return e=a.value,(null===A||void 0===A?void 0:A.find((function(n){return n.name===e.name})))?[2,"continue"]:[4,null===g.db||void 0===g.db?void 0:g.db.files.get(e.id)];case 1:return(n=t.sent())?(Y(e.id),[4,k.if.filesUpload({path:"/files/".concat(e.name),contents:n.file})]):[2,"continue"];case 2:return t.sent(),Y(void 0),S(),[2]}}))},i=H[Symbol.iterator](),o.label=2;case 2:return(e=(a=i.next()).done)?[3,5]:[5,(0,l.__values)(r())];case 3:o.sent(),o.label=4;case 4:return e=!0,[3,2];case 5:return[3,8];case 6:return s=o.sent(),n=!0,t=s,[3,8];case 7:try{e||null==i.return||i.return()}finally{if(n)throw t}return[7];case 8:return[2]}}))})),children:u("upload")}),(0,s.jsx)(x.zx,{onClick:(0,r.Z)((function(){var e;return(0,l.__generator)(this,(function(n){return P(),e=(0,a.Z)(B),null===g.db||void 0===g.db||g.db.books.bulkDelete(e),null===g.db||void 0===g.db||g.db.covers.bulkDelete(e),null===g.db||void 0===g.db||g.db.files.bulkDelete(e),S(function(){var e=(0,r.Z)((function(e){return(0,l.__generator)(this,(function(n){switch(n.label){case 0:return[4,k.if.filesDeleteBatch({entries:H.map((function(e){return{path:"/files/".concat(e.name)}}))})];case 1:return n.sent(),[2,null===e||void 0===e?void 0:e.filter((function(e){return!H.find((function(n){return n.name===e.name}))}))]}}))}));return function(n){return e.apply(this,arguments)}}(),{revalidate:!1}),[2]}))})),children:u("delete")})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(x.zx,{variant:"secondary",disabled:!n.length,onClick:k.P2,children:u("export")}),(0,s.jsxs)(x.zx,{className:"relative",children:[(0,s.jsx)("input",{type:"file",accept:"application/epub+zip,application/epub,application/zip",className:"absolute inset-0 cursor-pointer opacity-0",onChange:function(e){var n=e.target.files;n&&(0,y.Np)(n)}}),u("import")]})]})})]})]}),(0,s.jsx)("div",{className:"scroll h-full",children:(0,s.jsx)("ul",{className:"grid",style:{gridTemplateColumns:"repeat(auto-fill, minmax(calc(80px + 3vw), 1fr))",columnGap:(0,_.dR)(16,32),rowGap:(0,_.dR)(24,40)},children:n.map((function(e){return(0,s.jsx)(F,{book:e,covers:t,select:D,selected:Q(e.id),loading:M===e.id,toggle:X},e.id)}))})})]})},F=function(e){var n,t,i=e.book,a=e.covers,o=e.select,c=e.selected,d=e.loading,f=e.toggle,h=(0,w.MX)(),m=(0,v.useRouter)(),p=(0,w.XA)(),x=null===(n=null===a||void 0===a?void 0:a.find((function(e){return e.id===i.id})))||void 0===n?void 0:n.cover,g=null===(t=h.data)||void 0===t?void 0:t.find((function(e){return e.name===i.name})),y=c?b.y5A:b.hrt;return(0,s.jsxs)("div",{className:"relative flex flex-col",children:[(0,s.jsxs)("div",{role:"button",className:"border-inverse-on-surface relative border",onClick:(0,r.Z)((function(){return(0,l.__generator)(this,(function(e){switch(e.label){case 0:return o?(f(i.id),[3,4]):[3,1];case 1:return p?[4,m.push("/_")]:[3,3];case 2:e.sent(),e.label=3;case 3:j.r1.addTab(i),e.label=4;case 4:return[2]}}))})),children:[(0,s.jsx)("div",{className:(0,u.Z)("absolute bottom-0 h-1 bg-blue-500",d&&"progress-bit w-[5%]")}),void 0!==i.percentage&&(0,s.jsxs)("div",{className:"typescale-body-large absolute right-0 bg-gray-500/60 px-2 text-gray-100",children:[(100*i.percentage).toFixed(),"%"]}),(0,s.jsx)("img",{src:null!==x&&void 0!==x?x:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"><rect fill="gray" fill-opacity="0" width="1" height="1"/></svg>',alt:"Cover",className:"mx-auto aspect-[9/12] object-cover",draggable:!1}),o&&(0,s.jsx)("div",{className:"absolute bottom-1 right-1",children:(0,s.jsx)(y,{size:24,className:(0,u.Z)("-m-1",c?"text-tertiary":"text-outline")})})]}),(0,s.jsxs)("div",{className:"line-clamp-2 text-on-surface-variant typescale-body-small lg:typescale-body-medium mt-2 w-full",title:i.name,children:[(0,s.jsx)(b.ZSR,{className:(0,u.Z)("mr-1 mb-0.5 inline",g?"text-tertiary":"text-surface-variant"),size:16}),i.name]})]})}}}]);
//# sourceMappingURL=292-3db4779e604d147c.js.map